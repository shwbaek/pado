<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>pado.optical_element - PADO Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=359f0c69" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     Pytorch Automatic Differentiable Optics 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">PADO Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky">
<a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-brand-container">
    <img class="sidebar-logo" src="../../_static/logo_1.0.0.svg" alt="Logo"/>
    <p class="sidebar-brand-text">PADO Documentation</p>
  </div>
</a>
 <form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/light.html">Light Field</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Light Field</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.light.Light.html">pado.light.Light</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.light.PolarizedLight.html">pado.light.PolarizedLight</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/optical_element.html">Optical Elements</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Optical Elements</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.OpticalElement.html">pado.optical_element.OpticalElement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.RefractiveLens.html">pado.optical_element.RefractiveLens</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.CosineSquaredLens.html">pado.optical_element.CosineSquaredLens</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.DOE.html">pado.optical_element.DOE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.SLM.html">pado.optical_element.SLM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.PolarizedSLM.html">pado.optical_element.PolarizedSLM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.Aperture.html">pado.optical_element.Aperture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.height2phase.html">pado.optical_element.height2phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.phase2height.html">pado.optical_element.phase2height</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.optical_element.quantize.html">pado.optical_element.quantize</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/propagator.html">Light Propagation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Light Propagation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.propagator.Propagator.html">pado.propagator.Propagator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.propagator.compute_pad_width.html">pado.propagator.compute_pad_width</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.propagator.unpad.html">pado.propagator.unpad</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/material.html">Optical Materials</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Optical Materials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.material.Material.html">pado.material.Material</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/math.html">Mathematical Utilities</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Mathematical Utilities</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.wrap_phase.html">pado.math.wrap_phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.fft.html">pado.math.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.ifft.html">pado.math.ifft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.calculate_psnr.html">pado.math.calculate_psnr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.calculate_ssim.html">pado.math.calculate_ssim</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.gaussian_window.html">pado.math.gaussian_window</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.sc_dft_1d.html">pado.math.sc_dft_1d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.sc_idft_1d.html">pado.math.sc_idft_1d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.sc_dft_2d.html">pado.math.sc_dft_2d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.sc_idft_2d.html">pado.math.sc_idft_2d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/_autosummary/pado.math.compute_scasm_transfer_function.html">pado.math.compute_scasm_transfer_function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pado.optical_element</h1><div class="highlight"><pre>
<span></span><span class="c1">########################################################</span>
<span class="c1"># The MIT License (MIT)</span>
<span class="c1">#</span>
<span class="c1"># PADO (Pytorch Automatic Differentiable Optics)</span>
<span class="c1"># Copyright (c) 2025 by POSTECH Computer Graphics Lab</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<span class="c1"># THE SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1"># Contact:</span>
<span class="c1"># Lead Developer: Dong-Ha Shin (0218sdh@gmail.com)</span>
<span class="c1"># Corresponding Author: Seung-Hwan Baek (shwbaek@postech.ac.kr)</span>
<span class="c1">#</span>
<span class="c1">########################################################</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.math</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_phase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.math</span><span class="w"> </span><span class="kn">import</span> <span class="n">nm</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="n">m</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.light</span><span class="w"> </span><span class="kn">import</span> <span class="n">Light</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.material</span><span class="w"> </span><span class="kn">import</span> <span class="n">Material</span>


<div class="viewcode-block" id="OpticalElement">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpticalElement</span><span class="p">:</span>
<div class="viewcode-block" id="OpticalElement.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                 <span class="n">field_change</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> 
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;not defined&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base class for optical elements that modify incident light wavefront.</span>

<span class="sd">        The wavefront modification is stored as amplitude and phase tensors.</span>
<span class="sd">        Note that the number of channels is one for wavefront modulation.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Dimensions (B, 1, R, C) for batch size, channels, rows, columns</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            wvl (float): Wavelength of light in meters</span>
<span class="sd">            field_change (torch.Tensor, optional): Wavefront modification tensor [B, C, H, W]</span>
<span class="sd">            device (str): Device to store wavefront (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>
<span class="sd">            name (str): Name identifier for this optical element</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39;: scalar, &#39;polar&#39;: vector)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.field_change.shape</span>
<span class="sd">            torch.Size([1, 1, 100, 100])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">pitch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">if</span> <span class="n">field_change</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cfloat</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span> <span class="o">=</span> <span class="n">field_change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polar</span> <span class="o">=</span> <span class="n">polar</span></div>


<div class="viewcode-block" id="OpticalElement.forward">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">:</span> <span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Light&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propagate incident light through the optical element.</span>

<span class="sd">        Args:</span>
<span class="sd">            light (Light): Input light field</span>
<span class="sd">            interp_mode (str): Interpolation method for resizing (&#39;bilinear&#39;, &#39;nearest&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Light: Light field after interaction with optical element</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement(dim=(1, 1, 64, 64), pitch=2e-6)</span>
<span class="sd">            &gt;&gt;&gt; light = Light(dim=(1, 1, 64, 64), pitch=2e-6)</span>
<span class="sd">            &gt;&gt;&gt; output = element.forward(light)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polar</span><span class="o">==</span><span class="s1">&#39;non&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_non_polar</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polar</span><span class="o">==</span><span class="s1">&#39;polar&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_non_polar</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">get_lightX</span><span class="p">(),</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_non_polar</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">get_lightY</span><span class="p">(),</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_lightX</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_lightY</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">light</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Polar is not set.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalElement.forward_non_polar">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.forward_non_polar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward_non_polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">:</span> <span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Light&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Propagate non-polarized light through the optical element.</span>

<span class="sd">        Handles resolution matching between light and optical element by resizing and padding</span>
<span class="sd">        as needed. Applies the optical element&#39;s field modulation to the input light.</span>

<span class="sd">        Args:</span>
<span class="sd">            light (Light): Input light field to propagate through the element</span>
<span class="sd">            interp_mode (str): Interpolation method for resizing (&#39;bilinear&#39;, &#39;nearest&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Light: Modified light field after interaction with optical element</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If wavelengths of light and element don&#39;t match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wavelength mismatch: light wavelength </span><span class="si">{</span><span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="si">}</span><span class="s1"> != element wavelength </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># make sure that light and optical element have the same resolution, i.e. pixel count, by padding the smaller one</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">r1</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">c1</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>

        <span class="n">light</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">field</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">light</span></div>


<div class="viewcode-block" id="OpticalElement.get_amplitude_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_amplitude_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_amplitude_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return amplitude change of the wavefront.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Amplitude change of the wavefront</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; amp = element.get_amplitude_change()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpticalElement.get_device">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_device">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the device on which tensors are stored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The device identifier (e.g., &#39;cpu&#39;, &#39;cuda:0&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span></div>


<div class="viewcode-block" id="OpticalElement.get_field_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_field_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the field_change tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: The field_change tensor representing amplitude and phase changes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span></div>


<div class="viewcode-block" id="OpticalElement.get_name">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the name of the optical element.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The name identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="OpticalElement.get_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return phase change of the wavefront.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Phase change of the wavefront</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; phase = element.get_phase_change()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="o">.</span><span class="n">angle</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpticalElement.get_pitch">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_pitch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pitch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the pixel pitch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The pixel pitch in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span></div>


<div class="viewcode-block" id="OpticalElement.get_polar">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_polar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_polar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the polarization mode.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The polarization mode (&#39;non&#39; for scalar, &#39;polar&#39; for vector).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">polar</span></div>


<div class="viewcode-block" id="OpticalElement.get_wvl">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.get_wvl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wvl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the wavelength.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The wavelength in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span></div>


<div class="viewcode-block" id="OpticalElement.pad">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.pad">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">padval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad the wavefront change with constant value.</span>

<span class="sd">        Args:</span>
<span class="sd">            pad_width (tuple): Padding width following torch.nn.functional.pad format</span>
<span class="sd">            padval (float): Value to pad with, only 0 supported currently</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If padval is not 0</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.pad((10,10,10,10))  # Add 10 pixels padding on all sides</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">padval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;only zero padding supported&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalElement.resize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.resize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize the wavefront change by changing the pixel pitch.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_pitch (float): New pixel pitch to use</span>
<span class="sd">            interp_mode (str): Interpolation method used in torch.nn.functional.interpolate</span>
<span class="sd">                - &#39;bilinear&#39;: Bilinear interpolation</span>
<span class="sd">                - &#39;nearest&#39;: Nearest neighbor interpolation</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.resize(1e-6)  # Resize to 1m pitch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="n">target_pitch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">interp_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">target_pitch</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalElement.set_amplitude_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_amplitude_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_amplitude_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set amplitude change for specific or all channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            amplitude (torch.Tensor): Amplitude change in polar representation</span>
<span class="sd">            c (int, optional): Channel index. If None, applies to all channels</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; amp = torch.ones((1,1,100,100))</span>
<span class="sd">            &gt;&gt;&gt; element.set_amplitude_change(amp)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">angle</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="o">.</span><span class="n">angle</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalElement.set_field_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_field_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_field_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set field change for specific or all channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_change (torch.Tensor): Field change in complex tensor</span>
<span class="sd">            c (int, optional): Channel index. If None, applies to all channels</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; field = torch.ones((1,1,100,100), dtype=torch.cfloat)</span>
<span class="sd">            &gt;&gt;&gt; element.set_field_change(field)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_change</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_change</span></div>


<div class="viewcode-block" id="OpticalElement.set_name">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the name of the optical element.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): The name identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


<div class="viewcode-block" id="OpticalElement.set_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase change for specific or all channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase (torch.Tensor): Phase change in polar representation</span>
<span class="sd">            c (int, optional): Channel index. If None, applies to all channels</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; phase = torch.zeros((1,1,100,100))</span>
<span class="sd">            &gt;&gt;&gt; element.set_phase_change(phase)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field_change</span><span class="p">[:,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpticalElement.set_pitch">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_pitch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_pitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the pixel pitch of the complex tensor.</span>

<span class="sd">        Args:</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.set_pitch(1e-6)  # Set 1m pitch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pitch</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pitch must be positive, got </span><span class="si">{</span><span class="n">pitch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">pitch</span></div>


<div class="viewcode-block" id="OpticalElement.set_polar">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_polar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_polar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set polarization mode for the optical element.</span>

<span class="sd">        Args:</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39;: scalar, &#39;polar&#39;: vector)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.set_polar(&#39;polar&#39;)  # Set vector field mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polar</span> <span class="o">=</span> <span class="n">polar</span></div>


<div class="viewcode-block" id="OpticalElement.set_wvl">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.set_wvl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_wvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the wavelength.</span>

<span class="sd">        Args:</span>
<span class="sd">            wvl (float): The wavelength in meters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span></div>


<div class="viewcode-block" id="OpticalElement.shape">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.shape">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return shape of light-wavefront modulation.</span>

<span class="sd">        The number of channels is one for wavefront modulation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: Dimensions (B, 1, R, C) for batch size, channels, rows, columns</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; element = OpticalElement((1,1,100,100), pitch=2e-6, wvl=500e-9)</span>
<span class="sd">            &gt;&gt;&gt; element.shape()</span>
<span class="sd">            (1, 1, 100, 100)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span></div>


<div class="viewcode-block" id="OpticalElement.visualize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.OpticalElement.visualize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize the wavefront modulation of the optical element.</span>

<span class="sd">        Displays amplitude and phase changes of the optical element&#39;s wavefront modulation.</span>
<span class="sd">        Creates subplots showing amplitude change and phase change for specified channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            b (int, optional): Batch index to visualize. Defaults to 0.</span>
<span class="sd">            c (int, optional): Channel index to visualize. If None, visualizes all channels.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; lens = RefractiveLens((1,1,512,512), 2e-6, 0.1, 633e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; lens.visualize()  # Visualize first batch, all channels</span>
<span class="sd">            &gt;&gt;&gt; lens.visualize(b=0, c=0)  # Visualize first batch, first channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;amplitude change&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;phase change&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            
            <span class="n">wvl_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span><span class="o">/</span><span class="n">nm</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[nm]&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="o">/</span><span class="n">nm</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[nm]&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">), &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;pitch:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="n">um</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[um], &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;wvl:</span><span class="si">{</span><span class="n">wvl_text</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;device:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="RefractiveLens">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.RefractiveLens">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RefractiveLens</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<div class="viewcode-block" id="RefractiveLens.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.RefractiveLens.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                 <span class="n">wvl</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> 
                 <span class="n">designated_wvl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a thin refractive lens optical element.</span>

<span class="sd">        Simulates a thin refractive lens that modifies the phase of incident light</span>
<span class="sd">        based on its focal length and wavelength.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Shape of the lens field (B, Ch, R, C) where:</span>
<span class="sd">                B: Batch size</span>
<span class="sd">                Ch: Number of channels</span>
<span class="sd">                R: Number of rows</span>
<span class="sd">                C: Number of columns</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            focal_length (float): Focal length of the lens in meters</span>
<span class="sd">            wvl (float or list): Wavelength(s) of light in meters. Can be single value or list for multi-channel</span>
<span class="sd">            device (str): Device to store the lens field (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>
<span class="sd">            polar (str, optional): Polarization mode. Defaults to &#39;non&#39;</span>
<span class="sd">            designated_wvl (float, optional): Override wavelength for all channels. Defaults to None</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Create single channel lens</span>
<span class="sd">            &gt;&gt;&gt; lens = RefractiveLens((1,1,512,512), 2e-6, 0.1, 633e-9, &#39;cpu&#39;)</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # Create multi-channel lens with different wavelengths</span>
<span class="sd">            &gt;&gt;&gt; lens = RefractiveLens((1,3,512,512), 2e-6, 0.1, [633e-9,532e-9,450e-9], &#39;cuda:0&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;refractive_lens&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">focal_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">focal_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;focal_length cannot be None&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">set_focal_length</span><span class="p">(</span><span class="n">focal_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Create unit amplitude field with exact 1.0 amplitude</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">field_change</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">field_change</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">designated_wvl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_phase</span><span class="p">(</span><span class="n">designated_wvl</span><span class="p">,</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># Create unit amplitude field with exact 1.0 amplitude</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">field_change</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">field_change</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shift_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># Create unit amplitude field with exact 1.0 amplitude</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">field_change</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">phase</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">field_change</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">i</span><span class="p">)</span></div>


<div class="viewcode-block" id="RefractiveLens.set_focal_length">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.RefractiveLens.set_focal_length">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_focal_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the focal length of the lens.</span>

<span class="sd">        Args:</span>
<span class="sd">            focal_length (float): New focal length in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; lens.set_focal_length(0.2)  # Set 20cm focal length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_length</span> <span class="o">=</span> <span class="n">focal_length</span></div>


<div class="viewcode-block" id="RefractiveLens.compute_phase">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.RefractiveLens.compute_phase">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the phase modulation for the lens.</span>

<span class="sd">        Calculates the phase change introduced by the lens based on its focal length,</span>
<span class="sd">        wavelength and any lateral shifts.</span>

<span class="sd">        Args:</span>
<span class="sd">            wvl (float): Wavelength of light in meters</span>
<span class="sd">            shift_x (float, optional): Horizontal displacement of lens center in meters. Defaults to 0</span>
<span class="sd">            shift_y (float, optional): Vertical displacement of lens center in meters. Defaults to 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Phase modulation pattern of the lens</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phase = lens.compute_phase(633e-9)  # Centered lens</span>
<span class="sd">            &gt;&gt;&gt; phase = lens.compute_phase(633e-9, shift_x=10e-6)  # Shifted lens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>

        <span class="n">theta_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wvl</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">xx</span><span class="o">-</span><span class="n">shift_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">shift_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">focal_length</span><span class="p">)</span>
        <span class="n">theta_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_change</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">theta_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">theta_change</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">theta_change</span></div>
</div>



<div class="viewcode-block" id="CosineSquaredLens">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.CosineSquaredLens">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CosineSquaredLens</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<div class="viewcode-block" id="CosineSquaredLens.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.CosineSquaredLens.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                 <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lens with cosine squared phase distribution.</span>

<span class="sd">        Creates a lens with phase distribution of form [1+cos(k*r^2)]/2.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Field dimensions (B, 1, R, C) - batch size, channels, rows, columns</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            focal_length (float): Focal length in meters</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            device (str): Device to store wavefront (&#39;cpu&#39;, &#39;cuda:0&#39;, ...)</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39;: scalar, &#39;polar&#39;: vector)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Create basic cosine squared lens</span>
<span class="sd">            &gt;&gt;&gt; lens = CosineSquaredLens((1,1,1024,1024), 2e-6, 0.1, 633e-9, &#39;cpu&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cosine_squared_lens&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">focal_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_and_set_phase_change</span><span class="p">()</span></div>


<div class="viewcode-block" id="CosineSquaredLens.compute_and_set_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.CosineSquaredLens.compute_and_set_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_and_set_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute and set the phase change induced by the lens.</span>

<span class="sd">        Calculates and applies phase change in range [0, ] to the lens.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; lens.compute_and_set_phase_change()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span>  <span class="c1"># Wave number</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>
        
        <span class="n">xx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Radius squared from the center</span>
        
        <span class="c1"># Calculate phase change based on pi*[1+cos(k*r^2)]/2 to adjust the range to [0, pi]</span>
        <span class="n">phase_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">r_squared</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">phase_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">phase_change</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Assuming potential multiple wavelengths or batch dimension</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_change</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">i</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="height2phase">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.height2phase">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">height2phase</span><span class="p">(</span><span class="n">height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">RI</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert material height to corresponding phase shift.</span>

<span class="sd">    Calculates phase shift from material height using wavelength and refractive index.</span>

<span class="sd">    Args:</span>
<span class="sd">        height (float): Height of material in meters</span>
<span class="sd">        wvl (float): Wavelength of light in meters</span>
<span class="sd">        RI (float): Refractive index of material at given wavelength</span>
<span class="sd">        wrap (bool): If True, wraps phase to [0,2] range</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Phase change induced by material height</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; height = 500e-9  # 500nm height</span>
<span class="sd">        &gt;&gt;&gt; phase = height2phase(height, 633e-9, 1.5)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dRI</span> <span class="o">=</span> <span class="n">RI</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">wv_n</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wvl</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">wv_n</span> <span class="o">*</span> <span class="n">dRI</span> <span class="o">*</span> <span class="n">height</span>
    <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">wrap_phase</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">stay_positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">phi</span></div>


<div class="viewcode-block" id="phase2height">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.phase2height">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phase2height</span><span class="p">(</span><span class="n">phase_u</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">RI</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">minh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert phase change to material height.</span>

<span class="sd">    Note that phase to height mapping is not one-to-one.</span>
<span class="sd">    There exists an integer phase wrapping factor:</span>
<span class="sd">    height = wvl/(RI-1) * (phase_u + i*2), where i is integer</span>
<span class="sd">    This function uses minimum height minh to constrain the conversion.</span>
<span class="sd">    Minimal height is chosen such that height is always &gt;= minh.</span>

<span class="sd">    Args:</span>
<span class="sd">        phase_u (torch.Tensor): Phase change of light</span>
<span class="sd">        wvl (float): Wavelength of light in meters</span>
<span class="sd">        RI (float): Refractive index of material at given wavelength</span>
<span class="sd">        minh (float): Minimum height constraint in meters</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Material height that induces the phase change</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; phase = torch.ones((1,1,1024,1024)) * np.pi</span>
<span class="sd">        &gt;&gt;&gt; height = phase2height(phase, 633e-9, 1.5, minh=100e-9)  # 100nm min height</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dRI</span> <span class="o">=</span> <span class="n">RI</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">minh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ceil</span><span class="p">(((</span><span class="n">dRI</span><span class="o">/</span><span class="n">wvl</span><span class="p">)</span><span class="o">*</span><span class="n">minh</span> <span class="o">-</span> <span class="n">phase_u</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">wvl</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_u</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">dRI</span>
    <span class="k">return</span> <span class="n">height</span></div>



<div class="viewcode-block" id="DOE">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DOE</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<div class="viewcode-block" id="DOE.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">material</span><span class="p">:</span> <span class="s1">&#39;Material&#39;</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diffractive optical element (DOE) that modifies incident light wavefront.</span>

<span class="sd">        The wavefront modification is determined by the material height profile.</span>
<span class="sd">        Supports both height and phase change specifications.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Dimensions (B, 1, R, C) for batch size, channels, rows, columns</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            material (Material): Material properties of the DOE</span>
<span class="sd">            wvl (float): Wavelength of light in meters</span>
<span class="sd">            device (str): Device to store wavefront (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>
<span class="sd">            height (torch.Tensor, optional): Height profile in meters</span>
<span class="sd">            phase_change (torch.Tensor, optional): Phase change profile</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39;: scalar, &#39;polar&#39;: vector)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Create DOE with specified height profile</span>
<span class="sd">            &gt;&gt;&gt; height = torch.ones((1,1,100,100)) * 500e-9  # 500nm height</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE(height.shape, 2e-6, material, 500e-9, &#39;cpu&#39;, height=height)</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; # Create DOE with specified phase profile</span>
<span class="sd">            &gt;&gt;&gt; phase = torch.ones((1,1,100,100)) * np.pi  #  phase</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE(phase.shape, 2e-6, material, 500e-9, &#39;cpu&#39;, phase_change=phase)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="o">=</span><span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="o">=</span><span class="n">wvl</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;doe&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="p">:</span> <span class="s1">&#39;Material&#39;</span> <span class="o">=</span> <span class="n">material</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initial DOE is tranparent and induces 0 phase delay</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">phase_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_change</span><span class="p">,</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">phase_change</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">sync_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">phase_change</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.visualize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.visualize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize the DOE wavefront modulation.</span>

<span class="sd">        Displays amplitude change, phase change and height profile.</span>

<span class="sd">        Args:</span>
<span class="sd">            b (int): Batch index to visualize, defaults to 0</span>
<span class="sd">            c (int): Channel index to visualize, defaults to 0</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.visualize()  # Shows modulation plots</span>
<span class="sd">            &gt;&gt;&gt; doe.visualize(b=1, c=0)  # Shows plots for batch index 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;amplitude change&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> 
                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;phase change&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> 
                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;height [um]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;pitch:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mf">1e-6</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[um], &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;wvl:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="o">/</span><span class="mf">1e-9</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[nm], &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;device:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DOE.set_diffraction_grating_1d">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_diffraction_grating_1d">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_diffraction_grating_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slit_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">minh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">maxh</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the wavefront modulation as a 1D diffraction grating.</span>

<span class="sd">        Create alternating height regions to form a binary phase grating.</span>

<span class="sd">        Args:</span>
<span class="sd">            slit_width (float): Width of each slit in meters</span>
<span class="sd">            minh (float): Minimum height in meters</span>
<span class="sd">            maxh (float): Maximum height in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_diffraction_grating_1d(10e-6, 0, 500e-9)  # 10m slits</span>
<span class="sd">            &gt;&gt;&gt; doe.visualize()  # Shows 1D grating pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slit_width_px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">slit_width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">slit_space_px</span> <span class="o">=</span> <span class="n">slit_width_px</span>

        <span class="n">dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">slit_num_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slit_width_px</span><span class="p">)</span>
        <span class="n">slit_num_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slit_width_px</span><span class="p">)</span>

        <span class="n">dg</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">minh</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slit_num_c</span><span class="p">)):</span>
            <span class="n">minc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">slit_width_px</span> <span class="o">+</span> <span class="n">slit_space_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">maxc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minc</span> <span class="o">+</span> <span class="n">slit_width_px</span><span class="p">)</span>

            <span class="n">dg</span><span class="p">[:,</span> <span class="n">minc</span><span class="p">:</span><span class="n">maxc</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxh</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">pc</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.set_diffraction_grating_2d">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_diffraction_grating_2d">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_diffraction_grating_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slit_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">minh</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">maxh</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the wavefront modulation as a 2D diffraction grating.</span>

<span class="sd">        Create a checkerboard pattern of alternating height regions.</span>

<span class="sd">        Args:</span>
<span class="sd">            slit_width (float): Width of each slit in meters</span>
<span class="sd">            minh (float): Minimum height in meters</span>
<span class="sd">            maxh (float): Maximum height in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_diffraction_grating_2d(10e-6, 0, 500e-9)  # 10m slits</span>
<span class="sd">            &gt;&gt;&gt; doe.visualize()  # Shows 2D grating pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slit_width_px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">slit_width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">slit_space_px</span> <span class="o">=</span> <span class="n">slit_width_px</span>

        <span class="n">dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">slit_num_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slit_width_px</span><span class="p">)</span>
        <span class="n">slit_num_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">slit_width_px</span><span class="p">)</span>

        <span class="n">dg</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">minh</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slit_num_r</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">slit_num_c</span><span class="p">)):</span>
                <span class="n">minc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">slit_width_px</span> <span class="o">+</span> <span class="n">slit_space_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">maxc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minc</span> <span class="o">+</span> <span class="n">slit_width_px</span><span class="p">)</span>
                <span class="n">minr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">slit_width_px</span> <span class="o">+</span> <span class="n">slit_space_px</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">maxr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minr</span> <span class="o">+</span> <span class="n">slit_width_px</span><span class="p">)</span>

                <span class="n">dg</span><span class="p">[</span><span class="n">minr</span><span class="p">:</span><span class="n">maxr</span><span class="p">,</span> <span class="n">minc</span><span class="p">:</span><span class="n">maxc</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxh</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.set_Fresnel_lens">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_Fresnel_lens">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_Fresnel_lens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the wavefront modulation as a Fresnel lens.</span>

<span class="sd">        Create a phase profile that focus light to a point.</span>

<span class="sd">        Args:</span>
<span class="sd">            focal_length (float): Focal length in meters</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            shift_x (float): Horizontal shift in meters. Defaults to 0</span>
<span class="sd">            shift_y (float): Vertical shift in meters. Defaults to 0</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,1024,1024), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_Fresnel_lens(0.1, 500e-9)  # f=10cm lens</span>
<span class="sd">            &gt;&gt;&gt; doe.set_Fresnel_lens(0.1, 500e-9, shift_x=50e-6)  # Shifted lens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">phase_u</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wvl</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                <span class="n">focal_length</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">-</span> <span class="n">focal_length</span>
        <span class="p">)</span>
        
        <span class="n">phase_w</span> <span class="o">=</span> <span class="n">wrap_phase</span><span class="p">(</span><span class="n">phase_u</span><span class="p">)</span>
        <span class="n">phase_w</span> <span class="o">=</span> <span class="n">phase_w</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_w</span><span class="p">,</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DOE.set_Fresnel_zone_plate_lens">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_Fresnel_zone_plate_lens">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_Fresnel_zone_plate_lens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set binary Fresnel zone plate pattern.</span>

<span class="sd">        Creates alternating opaque and transparent zones that focus light.</span>

<span class="sd">        Args:</span>
<span class="sd">            focal_length (float): Focal length in meters</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            shift_x (float): Horizontal shift in meters. Defaults to 0</span>
<span class="sd">            shift_y (float): Vertical shift in meters. Defaults to 0</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,1024,1024), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_Fresnel_zone_plate_lens(0.1, 500e-9)  # f=10cm lens</span>
<span class="sd">            &gt;&gt;&gt; doe.set_Fresnel_zone_plate_lens(0.1, 500e-9, shift_x=50e-6)  # Shifted lens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate the radial distance from the center</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">shift_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">shift_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Original phase calculation for a thin lens</span>
        <span class="n">original_phase</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wvl</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_squared</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">focal_length</span><span class="p">)</span>

        <span class="c1"># Fresnel zone plate phase calculation</span>
        <span class="c1"># Map phase to 0 or pi based on the sign of the cosine of the original phase</span>
        <span class="n">fresnel_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">original_phase</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">fresnel_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">fresnel_phase</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">fresnel_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">fresnel_phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">fresnel_phase</span><span class="p">,</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.sync_height_with_phase">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.sync_height_with_phase">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sync_height_with_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize height profile with current phase profile.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_phase_change(phase, sync_height=False)</span>
<span class="sd">            &gt;&gt;&gt; doe.sync_height_with_phase()  # Update height to match phase</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">phase2height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">get_RI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_height</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">sync_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.sync_phase_with_height">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.sync_phase_with_height">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sync_phase_with_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronize phase profile with current height profile.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.set_height(height, sync_phase=False)</span>
<span class="sd">            &gt;&gt;&gt; doe.sync_phase_with_height()  # Update phase to match height</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">height2phase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">get_RI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="DOE.resize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.resize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize DOE with a new pixel pitch.</span>

<span class="sd">        Resize field from which DOE height is recomputed.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_pitch (float): New pixel pitch in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.resize(1e-6)  # Change pitch to 1m</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">target_pitch</span><span class="p">)</span>  <span class="c1"># this changes the field change </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_height_with_phase</span><span class="p">()</span></div>


<div class="viewcode-block" id="DOE.get_height">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.get_height">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the height map of the DOE.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Height map in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; height = doe.get_height()  # Get current height profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span></div>

    
<div class="viewcode-block" id="DOE.change_wvl">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.change_wvl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_wvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the wavelength and update phase change.</span>

<span class="sd">        Args:</span>
<span class="sd">            wvl (float): New wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; doe.change_wvl(633e-9)  # Change to 633nm wavelength</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">height2phase</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">get_RI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phase</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">),</span> <span class="n">sync_height</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span></div>

    
<div class="viewcode-block" id="DOE.set_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sync_height</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase change induced by the DOE.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase_change (torch.Tensor): Phase change profile</span>
<span class="sd">            sync_height (bool): If True, syncs height profile</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; phase = torch.ones((1,1,100,100)) * np.pi</span>
<span class="sd">            &gt;&gt;&gt; doe.set_phase_change(phase, sync_height=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_change</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sync_height</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_height_with_phase</span><span class="p">()</span></div>


<div class="viewcode-block" id="DOE.set_field_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_field_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_field_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sync_height</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change the field change of the DOE.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_change (torch.Tensor): Complex field change tensor</span>
<span class="sd">            sync_height (bool): If True, syncs height profile</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; field = torch.exp(1j * torch.ones((1,1,100,100)))</span>
<span class="sd">            &gt;&gt;&gt; doe.set_field_change(field, sync_height=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">field_change</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sync_height</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_height_with_phase</span><span class="p">()</span></div>


<div class="viewcode-block" id="DOE.set_height">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.DOE.set_height">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sync_phase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the height map of the DOE.</span>

<span class="sd">        Args:</span>
<span class="sd">            height (torch.Tensor): Height map in meters</span>
<span class="sd">            sync_phase (bool): If True, syncs phase profile</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; doe = DOE((1,1,100,100), 2e-6, material, 500e-9, &#39;cpu&#39;)</span>
<span class="sd">            &gt;&gt;&gt; height = torch.ones((1,1,100,100)) * 500e-9</span>
<span class="sd">            &gt;&gt;&gt; doe.set_height(height, sync_phase=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="k">if</span> <span class="n">sync_phase</span><span class="p">:</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_phase_with_height</span><span class="p">()</span>      </div>
</div>



<div class="viewcode-block" id="SLM">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.SLM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SLM</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<div class="viewcode-block" id="SLM.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.SLM.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial Light Modulator (SLM) optical element.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Field dimensions (B, 1, R, C) for batch, channels, rows, cols</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            device (str): Device for computation (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39; or &#39;polar&#39;)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; slm = SLM(dim=(1,1,1024,1024), pitch=6.4e-6, wvl=633e-9, device=&#39;cuda:0&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SLM&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span></div>


<div class="viewcode-block" id="SLM.set_lens">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.SLM.set_lens">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_lens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase profile to implement a thin lens.</span>

<span class="sd">        Args:</span>
<span class="sd">            focal_length (float): Focal length in meters</span>
<span class="sd">            shift_x (float): Lateral shift in x direction in meters</span>
<span class="sd">            shift_y (float): Lateral shift in y direction in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; slm.set_lens(focal_length=0.5, shift_x=100e-6)  # 500mm focal length, 100m x-shift</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">phase_u</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">xx</span><span class="o">-</span><span class="n">shift_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">shift_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">focal_length</span><span class="p">)</span>
        <span class="n">phase_u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">phase_u</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">phase_w</span> <span class="o">=</span> <span class="n">wrap_phase</span><span class="p">(</span><span class="n">phase_u</span><span class="p">,</span> <span class="n">stay_positive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_w</span><span class="p">)</span></div>


<div class="viewcode-block" id="SLM.set_amplitude_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.SLM.set_amplitude_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_amplitude_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set amplitude modulation profile of the SLM.</span>

<span class="sd">        Args:</span>
<span class="sd">            amplitude (torch.Tensor): Amplitude modulation profile [B, 1, R, C]</span>
<span class="sd">            wvl (float): Operating wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; amp = torch.ones((1,1,1024,1024)) * 0.8  # 80% transmission</span>
<span class="sd">            &gt;&gt;&gt; slm.set_amplitude_change(amp, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_amplitude_change</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span></div>


<div class="viewcode-block" id="SLM.set_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.SLM.set_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase modulation profile of the SLM.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase_change (torch.Tensor): Phase modulation profile [B, 1, R, C] in radians</span>
<span class="sd">            wvl (float): Operating wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phase = torch.ones((1,1,1024,1024)) * np.pi  #  phase shift</span>
<span class="sd">            &gt;&gt;&gt; slm.set_phase_change(phase, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_change</span><span class="p">)</span></div>
</div>

        
        
<div class="viewcode-block" id="PolarizedSLM">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PolarizedSLM</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<div class="viewcode-block" id="PolarizedSLM.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SLM which can control phase &amp; amplitude of each polarization component.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Field dimensions (B, 1, R, C) for batch, channels, rows, cols</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            device (str): Device for computation (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; slm = PolarizedSLM(dim=(1,1,1024,1024), pitch=6.4e-6, wvl=633e-9, device=&#39;cuda:0&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Metasurface&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_amplitude_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_amplitude_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_amplitude_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set amplitude change for both polarization components.</span>

<span class="sd">        Args:</span>
<span class="sd">            amplitude (torch.Tensor): Amplitude change [B, 1, R, C, 2] in polar representation</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; amp = torch.ones((1,1,1024,1024,2)) * 0.8  # 80% transmission for both polarizations</span>
<span class="sd">            &gt;&gt;&gt; slm.set_amplitude_change(amp, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_amplitude_change</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_phase_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_phase_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phase_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase change for both polarization components.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase_change (torch.Tensor): Phase change [B, 1, R, C, 2] in polar representation</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phase = torch.ones((1,1,1024,1024,2)) * np.pi  #  phase shift for both polarizations</span>
<span class="sd">            &gt;&gt;&gt; slm.set_phase_change(phase, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase_change</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_amplitudeX_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_amplitudeX_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_amplitudeX_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set amplitude change for X polarization component.</span>

<span class="sd">        Args:</span>
<span class="sd">            amplitude (torch.Tensor): Amplitude change [B, 1, R, C] for X component</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ampX = torch.ones((1,1,1024,1024)) * 0.8  # 80% transmission for X polarization</span>
<span class="sd">            &gt;&gt;&gt; slm.set_amplitudeX_change(ampX, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()</span>
        <span class="n">amp</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_amplitude_change</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_amplitudeY_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_amplitudeY_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_amplitudeY_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set amplitude change for Y polarization component.</span>

<span class="sd">        Args:</span>
<span class="sd">            amplitude (torch.Tensor): Amplitude change [B, 1, R, C] for Y component</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ampY = torch.ones((1,1,1024,1024)) * 0.6  # 60% transmission for Y polarization</span>
<span class="sd">            &gt;&gt;&gt; slm.set_amplitudeY_change(ampY, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()</span>
        <span class="n">amp</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">amplitude</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_amplitude_change</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_phaseX_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_phaseX_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phaseX_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase change for X polarization component.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase_change (torch.Tensor): Phase change [B, 1, R, C] for X component</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phaseX = torch.ones((1,1,1024,1024)) * np.pi/2  # /2 phase shift for X polarization</span>
<span class="sd">            &gt;&gt;&gt; slm.set_phaseX_change(phaseX, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()</span>
        <span class="n">phase</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_change</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.set_phaseY_change">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.set_phaseY_change">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_phaseY_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_change</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set phase change for Y polarization component.</span>

<span class="sd">        Args:</span>
<span class="sd">            phase_change (torch.Tensor): Phase change [B, 1, R, C] for Y component</span>
<span class="sd">            wvl (float): Wavelength in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phaseY = torch.ones((1,1,1024,1024)) * np.pi  #  phase shift for Y polarization</span>
<span class="sd">            &gt;&gt;&gt; slm.set_phaseY_change(phaseY, wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span> <span class="o">=</span> <span class="n">wvl</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()</span>
        <span class="n">phase</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_change</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_phase_change</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span></div>


<div class="viewcode-block" id="PolarizedSLM.get_phase_changeX">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.get_phase_changeX">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_phase_changeX</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return phase change for X polarization component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Phase change [B, 1, R, C] for X component</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phaseX = slm.get_phase_changeX()  # Get X polarization phase profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="PolarizedSLM.get_phase_changeY">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.get_phase_changeY">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_phase_changeY</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return phase change for Y polarization component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Phase change [B, 1, R, C] for Y component</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; phaseY = slm.get_phase_changeY()  # Get Y polarization phase profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="PolarizedSLM.get_amplitude_changeX">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.get_amplitude_changeX">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_amplitude_changeX</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return amplitude change for X polarization component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Amplitude change [B, 1, R, C] for X component</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ampX = slm.get_amplitude_changeX()  # Get X polarization amplitude profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="PolarizedSLM.get_amplitude_changeY">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.get_amplitude_changeY">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_amplitude_changeY</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return amplitude change for Y polarization component.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Amplitude change [B, 1, R, C] for Y component</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ampY = slm.get_amplitude_changeY()  # Get Y polarization amplitude profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span></div>

        
<div class="viewcode-block" id="PolarizedSLM.forward">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.forward">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">light</span><span class="p">:</span> <span class="s1">&#39;Light&#39;</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Light&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply polarization-dependent modulation to input light.</span>

<span class="sd">        Args:</span>
<span class="sd">            light (Light): Input light field</span>
<span class="sd">            interp_mode (str): Interpolation mode for resizing (&#39;nearest&#39;, &#39;bilinear&#39;, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Light: Modulated light field</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; modulated_light = slm.forward(input_light)  # Apply polarization modulation</span>
<span class="sd">            &gt;&gt;&gt; modulated_light = slm.forward(input_light, interp_mode=&#39;bilinear&#39;)  # Use bilinear interpolation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">wvl</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wavelength mismatch: light wavelength </span><span class="si">{</span><span class="n">light</span><span class="o">.</span><span class="n">wvl</span><span class="si">}</span><span class="s1"> != element wavelength </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">pitch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">interp_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
            
        <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">r1</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">c1</span>
        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">light</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">light</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">pad_width</span><span class="p">)</span>
        
        <span class="c1"># Ensure compatible shapes for broadcasting</span>
        <span class="n">light_phase</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">get_phase</span><span class="p">()</span>
        <span class="n">phase_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">()</span>
        
        <span class="c1"># Check if shapes are compatible and reshape if needed</span>
        <span class="k">if</span> <span class="n">light_phase</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">phase_change</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="c1"># Ensure light_phase has the same shape as phase_change for proper broadcasting</span>
            <span class="k">if</span> <span class="n">light_phase</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">phase_change</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># Add polarization dimension if missing</span>
                <span class="n">light_phase</span> <span class="o">=</span> <span class="n">light_phase</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">light_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Duplicate the phase for both polarizations</span>
                    <span class="n">light_phase</span> <span class="o">=</span> <span class="n">light_phase</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Apply phase modulation with proper shape handling</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">light_phase</span> <span class="o">+</span> <span class="n">phase_change</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        
        <span class="c1"># Set the modulated phase and amplitude for each polarization component</span>
        <span class="n">light</span><span class="o">.</span><span class="n">set_phaseX</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">light</span><span class="o">.</span><span class="n">set_phaseY</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">light</span><span class="o">.</span><span class="n">set_amplitudeX</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">get_amplitudeX</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">light</span><span class="o">.</span><span class="n">set_amplitudeY</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">get_amplitudeY</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">()[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">light</span></div>


<div class="viewcode-block" id="PolarizedSLM.pad">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.pad">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">padval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad amplitude and phase changes with constant value.</span>

<span class="sd">        Args:</span>
<span class="sd">            pad_width (tuple): Padding dimensions (left, right, top, bottom)</span>
<span class="sd">            padval (int): Padding value (only 0 supported)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; slm.pad((16,16,16,16))  # Add 16 pixels padding on all sides</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">padval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_change</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_change</span><span class="p">(),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pad_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;only zero padding supported&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pad_width</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_width</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pad_width</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_width</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="PolarizedSLM.visualize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.PolarizedSLM.visualize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize amplitude and phase modulation for both polarizations.</span>

<span class="sd">        Args:</span>
<span class="sd">            b (int): Batch index to visualize, default 0</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; slm.visualize()  # Visualize first batch</span>
<span class="sd">            &gt;&gt;&gt; slm.visualize(b=1)  # Visualize second batch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_changeX</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;amplitude change X&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_changeX</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;phase change X&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude_changeY</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;amplitude change Y&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_phase_changeY</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">b</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;phase change Y&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;pitch:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="o">/</span><span class="mf">1e-6</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[um], &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;wvl:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wvl</span><span class="o">/</span><span class="mf">1e-9</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">[nm], &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;device:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Aperture">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.Aperture">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Aperture</span><span class="p">(</span><span class="n">OpticalElement</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aperture optical element for amplitude modulation.</span>
<span class="sd">    </span>
<span class="sd">    Implement square or circular aperture that modulate light amplitude.</span>
<span class="sd">    Support both polarized and non-polarized light.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Aperture.__init__">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.Aperture.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">aperture_diameter</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">aperture_shape</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wvl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">polar</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;non&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create aperture optical element instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            dim (tuple): Field dimensions (B, 1, R, C) for batch, channels, rows, cols</span>
<span class="sd">            pitch (float): Pixel pitch in meters</span>
<span class="sd">            aperture_diameter (float): Diameter of aperture in meters</span>
<span class="sd">            aperture_shape (str): Shape of aperture (&#39;square&#39; or &#39;circle&#39;)</span>
<span class="sd">            wvl (float): Wavelength in meters</span>
<span class="sd">            device (str): Device for computation (&#39;cpu&#39;, &#39;cuda:0&#39;, etc.)</span>
<span class="sd">            polar (str): Polarization mode (&#39;non&#39;, &#39;x&#39;, &#39;y&#39;, &#39;xy&#39;)</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; aperture = Aperture(dim=(1,1,1024,1024), pitch=6.4e-6, </span>
<span class="sd">            ...                    aperture_diameter=1e-3, aperture_shape=&#39;circle&#39;,</span>
<span class="sd">            ...                    wvl=633e-9)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">wvl</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;aperture&quot;</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aperture_diameter</span> <span class="o">=</span> <span class="n">aperture_diameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture_shape</span> <span class="o">=</span> <span class="n">aperture_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_change</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_shape</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_square</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_circle</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Aperture.set_square">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.Aperture.set_square">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_square</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set square aperture amplitude modulation.</span>

<span class="sd">        Create square aperture mask centered on optical axis.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; aperture.set_square()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture_shape</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span>

        <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">max_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_diameter</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">amp</span><span class="p">[</span><span class="n">amp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-20</span>  <span class="c1"># to enable stable learning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span></div>


<div class="viewcode-block" id="Aperture.set_circle">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.Aperture.set_circle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dia</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set circular aperture amplitude modulation.</span>

<span class="sd">        Create circular aperture mask with optional offset and diameter.</span>

<span class="sd">        Args:</span>
<span class="sd">            cx (float): Center x-offset in pixels</span>
<span class="sd">            cy (float): Center y-offset in pixels  </span>
<span class="sd">            dia (float, optional): Circle diameter in meters</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; aperture.set_circle()  # Centered circle</span>
<span class="sd">            &gt;&gt;&gt; aperture.set_circle(cx=10, cy=-10, dia=2e-3)  # Offset circle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">cx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">cy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">r2</span><span class="p">[</span><span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dia</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aperture_diameter</span> <span class="o">=</span> <span class="n">dia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aperture_shape</span> <span class="o">=</span> <span class="s1">&#39;circle&#39;</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aperture_diameter</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">max_val</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">amp</span><span class="p">[</span><span class="n">amp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_field_change</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="quantize">
<a class="viewcode-back" href="../../api/pado.html#pado.optical_element.quantize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">quantize</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">levels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">include_vmax</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quantize floating point array.</span>

<span class="sd">    Discretize input array into specified number of levels.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (torch.Tensor or np.ndarray): Input array to quantize</span>
<span class="sd">        levels (int): Number of quantization levels</span>
<span class="sd">        vmin (float, optional): Minimum value for quantization</span>
<span class="sd">        vmax (float, optional): Maximum value for quantization</span>
<span class="sd">        include_vmax (bool): Whether to include max value in quantization</span>
<span class="sd">            True: Quantize with spacing of 1/levels</span>
<span class="sd">            False: Quantize with spacing of 1/(levels-1)</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor or np.ndarray: Quantized array</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(100)</span>
<span class="sd">        &gt;&gt;&gt; x_quant = quantize(x, levels=8)</span>
<span class="sd">        &gt;&gt;&gt; x_quant = quantize(x, levels=16, vmin=-1, vmax=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">include_vmax</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">levels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">levelized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">normalized</span> <span class="o">*</span> <span class="n">levels</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>    
            <span class="n">levelized</span> <span class="o">=</span> <span class="p">(</span><span class="n">normalized</span> <span class="o">*</span> <span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">levelized</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">vmin</span>
        <span class="n">result</span><span class="p">[</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="n">result</span><span class="p">[</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>
    
    <span class="k">elif</span> <span class="n">include_vmax</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">space</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">levels</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmin</span> <span class="o">+</span> <span class="n">space</span><span class="o">*</span><span class="p">(</span><span class="n">levels</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="n">space</span><span class="p">))</span><span class="o">*</span><span class="n">space</span> <span class="o">+</span> <span class="n">vmin</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>    
            <span class="n">result</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span><span class="o">-</span><span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="n">space</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">())</span><span class="o">*</span><span class="n">space</span> <span class="o">+</span> <span class="n">vmin</span>
        <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">&lt;</span><span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">&gt;</span><span class="n">vmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmax</span>
    
    <span class="k">return</span> <span class="n">result</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Seung-Hwan Baek, Dong-Ha Shin, and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=3ceafa3f"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>